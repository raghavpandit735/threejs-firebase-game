/*
 threejsthing 2016-06-28 
*/
"use strict";var app=angular.module("app",["ngRoute","firebase","angular-toArrayFilter"]).config(["$locationProvider","$routeProvider",function(a,b){a.html5Mode(!0),b.when("/game",{templateUrl:"views/game.html",controller:"GameCtrl"}),b.when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}),b.otherwise({redirectTo:"/login"})}]).run();angular.module("angular-toArrayFilter",[]).filter("toArray",function(){return function(a,b){return angular.isObject(a)?b===!1?Object.keys(a).map(function(b){return a[b]}):Object.keys(a).map(function(b){var c=a[b];return angular.isObject(c)?Object.defineProperty(c,"$key",{enumerable:!1,value:b}):{$key:b,$value:c}}):a}}),app.controller("LoginCtrl",["$scope","$location","$firebase","$firebaseAuth","$firebaseObject","$firebaseArray",function(a,b,c,d,e,f){a.authObj=d(),a.signIn=function(){a.firebaseUser=null,a.error=null,a.authObj.$signInAnonymously().then(function(a){})["catch"](function(b){a.error=b})},a.signInWithFb=function(){a.firebaseUser=null,a.error=null,$(".fb-login").addClass("loading"),a.authObj.$signInWithPopup("facebook").then(function(a){console.log("Signed in as:",a.uid)})["catch"](function(b){a.error=b,console.log("Authentication failed:",b)})},a.authObj.$onAuthStateChanged(function(c){var d=a.authObj.$getAuth();if(d){var e=firebase.database().ref().child("users/"+c.uid);firebase.database().ref().child("loggedIn/"+c.uid);if(null!==c.displayName&&"undefined"!=typeof c.displayName){var f=c.displayName.split(" ");e.child("name").set(f[0]+" "+f[1].charAt(0)),e.child("uid").set(c.uid),e.child("dp").set(c.photoURL)}else a.displayName||(a.displayName="Anon"),null!==e&&"undefined"!=typeof e&&null!==e.child("name").$value&&"undefined"!=typeof e.child("name").$value||(e.child("name").set(a.displayName),e.child("uid").set(c.uid));b.path("/game")}else a.firebaseUser=null,console.log("Signed out")})}]),app.controller("GameCtrl",["$scope","$location","$firebase","$firebaseAuth","$firebaseObject","$firebaseArray","soundcloud",function(a,b,c,d,e,f,g){function h(a,b,c){return a+c*Math.floor(Math.random()*(b-a)/c)}function i(){function a(a){ea.style.display=""}function b(a){if(ea.style.display="none",d.requestPointerLock=d.requestPointerLock||d.mozRequestPointerLock||d.webkitRequestPointerLock,/Firefox/i.test(navigator.userAgent)){var b=function(a){document.fullscreenElement!==d&&document.mozFullscreenElement!==d&&document.mozFullScreenElement!==d||(document.removeEventListener("fullscreenchange",b),document.removeEventListener("mozfullscreenchange",b),d.requestPointerLock())};document.addEventListener("fullscreenchange",b,!1),document.addEventListener("mozfullscreenchange",b,!1),d.requestFullscreen=d.requestFullscreen||d.mozRequestFullscreen||d.mozRequestFullScreen||d.webkitRequestFullscreen,d.requestFullscreen()}else d.requestPointerLock()}var c="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(c){var d=document.body,e=function(a){document.pointerLockElement===d||document.mozPointerLockElement===d||document.webkitPointerLockElement===d?(fa=!0,B.enabled=!0,blocker.style.display="none"):(B.enabled=!1,blocker.style.display="flex",ea.style.display="")};document.addEventListener("pointerlockchange",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("webkitpointerlockchange",e,!1),document.addEventListener("pointerlockerror",a,!1),document.addEventListener("mozpointerlockerror",a,!1),document.addEventListener("webkitpointerlockerror",a,!1),i.instructionsListener=b,ea.addEventListener("click",b,!1),aa.innerHTML="Click to play"}else ea.innerHTML="Your browser doesn't seem to support Pointer Lock API"}function j(){function a(){try{var a=document.createElement("canvas");return!(!window.WebGLRenderingContext||!a.getContext("webgl")&&!a.getContext("experimental-webgl"))}catch(b){return!1}}w=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1e3),w.position.y=10,x=new THREE.Scene,x.fog=new THREE.Fog(16777215,0,800),B=new THREE.PointerLockControls(w),x.add(B.getObject()),i=new THREE.BoxGeometry(Y,Z,_),K=new THREE.Object3D;for(var b=0;b<250;b++)z=new THREE.MeshPhongMaterial({shininess:10,specular:16776932}),A=new THREE.Mesh(i,z),A.position.x=h(25,1e3,50),A.position.y=h(100,1e3,50),A.position.z=h(25,1e3,50),A.castShadow=!0,A.receiveShadow=!0,A.matrixAutoUpdate=!0,A.updateMatrix(),z.color.setHSL(2*Math.random()+.5,100*Math.random(),.25*Math.random()+.75),T.push(A),K.add(A),x.add(K);z=new THREE.MeshPhongMaterial({shininess:30,vertexColors:THREE.VertexColors}),z.transparent=!0,i=new THREE.BoxGeometry(Y,Z,_);for(var b=0,c=i.faces.length;b<c;b++){var d=i.faces[b];d.vertexColors[0]=(new THREE.Color).setHSL(150,50,.25*Math.random()+.75),d.vertexColors[1]=(new THREE.Color).setHSL(170,50,.25*Math.random()+.75),d.vertexColors[2]=(new THREE.Color).setHSL(190,50,.25*Math.random()+.75)}C=new THREE.Mesh(i,z),C.position.x=Math.floor(251*Math.random())+50,C.position.y=150,C.position.z=Math.floor(251*Math.random())+50,C.castShadow=!0,C.receiveShadow=!0,C.matrixAutoUpdate=!0,C.updateMatrix(),T.push(C),x.add(C),i=new THREE.BoxGeometry(50,5,50),z=new THREE.MeshPhongMaterial({color:16187235,specular:16724563,shininess:30});for(var b=0;b<150;b++)A=new THREE.Mesh(i,z),A.position.x=h(25,1e3,50),A.position.y=h(50,1e3,25),A.position.z=h(25,1e3,50),A.castShadow=!0,A.receiveShadow=!0,A.matrixAutoUpdate=!0,A.updateMatrix(),U.push(A),x.add(A);for(var e=new THREE.CylinderGeometry(15,15,5,64),f=new THREE.MeshPhongMaterial({color:7733126,specular:62207,shininess:20}),b=0;b<p.amount.gems;b++)A=new THREE.Mesh(e,f),A.position.x=h(0,1e3,50),A.position.y=h(200,1e3,50),A.position.z=h(0,1e3,50),A.rotation.x=Math.random()*Math.PI,A.rotation.y=Math.random()*Math.PI,A.castShadow=!0,A.receiveShadow=!0,A.matrixAutoUpdate=!0,A.updateMatrix(),Q.push(A),x.add(A);var g=new THREE.TetrahedronGeometry(20,0);for(f=new THREE.MeshPhongMaterial({color:14290943,specular:16777215,shading:THREE.FlatShading,shininess:20}),b=0;b<p.amount.supergem;b++)A=new THREE.Mesh(g,f),A.position.x=h(0,1e3,50),A.position.y=h(600,1e3,50),A.position.z=h(0,1e3,50),A.rotation.x=Math.random()*Math.PI,A.rotation.y=Math.random()*Math.PI,A.castShadow=!0,A.receiveShadow=!0,A.matrixAutoUpdate=!0,A.updateMatrix(),R.push(A),x.add(A);var g=new THREE.IcosahedronGeometry(10,0);for(f=new THREE.MeshPhongMaterial({color:2566178,shininess:10,specular:16777215,shading:THREE.FlatShading}),b=0;b<p.amount.movingSupergem;b++)A=new THREE.Mesh(g,f),A.position.x=h(0,1e3,50),A.position.y=h(150,300,50),A.position.z=h(0,1e3,50),A.castShadow=!0,A.receiveShadow=!0,A.matrixAutoUpdate=!0,A.updateMatrix(),x.add(A),S.push(A);var i=new THREE.PlaneGeometry(3e3,3e3,50,50);i.rotateX(-Math.PI/2);for(var b=0,c=i.vertices.length;b<c;b++){var j=i.vertices[b];j.x+=15,j.y+=40*Math.random()-5,j.z+=30}for(var b=0,c=i.faces.length;b<c;b++){var d=i.faces[b];d.vertexColors[0]=(new THREE.Color).setRGB(.01,.01,.01),d.vertexColors[1]=(new THREE.Color).setRGB(0,0,0),d.vertexColors[2]=(new THREE.Color).setRGB(0,0,0)}z=new THREE.MeshBasicMaterial({vertexColors:THREE.VertexColors}),A=new THREE.Mesh(i,z),A.castShadow=!0,A.receiveShadow=!0,A.position.x=500,A.position.z=500,x.add(A),V.push(A),G=new THREE.DirectionalLight(16776932,.2),x.add(G),H=new THREE.PointLight(16776932,.2,1200),H.castShadow=!0,x.add(H),E=new THREE.BoxGeometry(50,50,50),F=new THREE.Mesh(E,new THREE.MeshPhongMaterial({})),F.transparent=!0,x.add(F),D=new THREE.Raycaster(new THREE.Vector3,new THREE.Vector3(0,(-1),0),0,20),B.getObject().position.x=C.position.x,B.getObject().position.z=C.position.z,B.getObject().position.y=350;var l=function(a){switch(a.keyCode){case 38:case 87:ga=!0;break;case 37:case 65:ia=!0;break;case 40:case 83:ha=!0;break;case 39:case 68:ja=!0;break;case 32:if(J)return;J=!0,ka===!0&&(la.y+=450,ka=!1)}},m=function(a){switch(a.keyCode){case 38:case 87:ga=!1;break;case 37:case 65:ia=!1;break;case 40:case 83:ha=!1;break;case 39:case 68:ja=!1;break;case 32:J=!1}};document.addEventListener("keydown",l,!1),document.addEventListener("keyup",m,!1),y=a()?new THREE.WebGLRenderer({antialias:!0,alpha:!0}):new THREE.CanvasRenderer({antialias:!0,alpha:!0}),y.setClearColor(16777215),a()&&(y.shadowMap.enabled=!0),y.setPixelRatio(window.devicePixelRatio),y.setSize(window.innerWidth,window.innerHeight),N.appendChild(y.domElement),window.addEventListener("resize",k,!1)}function k(){L=window.innerWidth/2,M=window.innerHeight/2,w.aspect=window.innerWidth/window.innerHeight,w.updateProjectionMatrix(),y.setSize(window.innerWidth,window.innerHeight)}function l(){I=requestAnimationFrame(l),m()}function m(){pa.getByteFrequencyData(qa);Date.now();w.updateProjectionMatrix(),K.position.y=.04*qa[1];for(var b=0;b<R.length;b++)R[b].translateY(.008*qa[18]);if(fa){H.position.copy(B.getObject().position),F.position.copy(B.getObject().position),D.ray.origin.copy(B.getObject().position);var c,d=.001*Date.now(),e=D.intersectObjects(T),f=(D.intersectObjects(Q),D.intersectObjects(U)),g=D.intersectObjects(V),h=e.length>0,j=f.length>0,k=g.length>0;c=50;for(var b=0;b<Q.length;b++)Q[b].rotation.z=1*d,Q[b].position.distanceTo(B.getObject().position)<=c&&(x.remove(Q[b]),Q.splice(b,1),s.play(),O+=p.points.gem,ba.innerHTML=O.toString(),a.gemsCollected=a.gemsCollected+1,a.updateScore(O));for(var b=0;b<R.length;b++)R[b].rotation.x=1*d,R[b].position.distanceTo(B.getObject().position)<=c&&(x.remove(R[b]),R.splice(b,1),s.play(),O+=p.points.supergem,ba.innerHTML=O.toString(),a.supergemsCollected=a.supergemsCollected+1,a.updateScore(O));for(var b=0;b<S.length;b++)S[b].rotation.x=1*d,S[b].rotation.y=2.5*d,S[b].position.y<1500&&(S[b].position.y+=.75),S[b].position.distanceTo(B.getObject().position)<=c&&(x.remove(S[b]),S.splice(b,1),v.play(),O+=p.points.movingSupergem,ba.innerHTML=O.toString(),a.movingSupergemsCollected=a.movingSupergemsCollected+1,a.updateScore(O));if(0===Q.length&&0===R.length){var l=50*P,m=O+l;$("span.play").hide(),$("#riperoo").fadeIn(250),ca.innerHTML="You won!<br/><strong>Score: </strong>"+O.toString()+"<br/><strong>Lives multiplier: </strong>"+l.toString()+"<br/><span>Final Score: "+m.toString()+"</span>",a.setScore(m),u.play(),B.enabled=!1,blocker.style.display="flex",ea.style.display="",ea.removeEventListener("click",i.instructionsListener,!1),document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock,document.exitPointerLock()}k===!0&&(W===!0?W=!1:(t.play(),$("#hurt").fadeIn(75),$("#hurt").fadeOut(200),P-=1,da.innerHTML=P.toString())),j===!0&&u.play(),0===P&&(a.setScore(O),$("span.play").hide(),$("#riperoo").fadeIn(250),ca.innerHTML="<span>Final Score: "+O.toString()+"</span>",B.enabled=!1,ea.removeEventListener("click",i.instructionsListener,!1),blocker.style.display="flex",ea.style.display="",document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock,document.exitPointerLock());for(var b=0;b<U.length;b++)U[b].position.distanceTo(B.getObject().position)<=c&&j===!0&&(U[b].position.y-=25);var d=performance.now(),n=(d-X)/1e3;la.x-=10*la.x*n,la.z-=10*la.z*n,la.y-=9.8*100*n,ga&&(la.z-=1500*n),ga&&ka===!1&&B.getObject().position.y>10&&(la.z-=15),ha&&(la.z+=1500*n),ha&&ka===!1&&B.getObject().position.y>10&&(la.z+=15),ia&&(la.x-=1e3*n),ia&&ka===!1&&B.getObject().position.y>10&&(la.x-=15),ja&&(la.x+=1e3*n),ja&&ka===!1&&B.getObject().position.y>10&&(la.x+=15),h===!0||j===!0?(la.y=Math.max(0,la.y),ka=!0):ka=!1,j!==!0&&k!==!0||(la.y=Math.max(0,la.y),ka=!0,la.y+=650),B.getObject().translateX(la.x*n),B.getObject().translateY(la.y*n),B.getObject().translateZ(la.z*n),B.getObject().position.y<10&&(la.y=0,B.getObject().position.y=10,ka=!0),X=d}y.render(x,w)}a.authObj=d();firebase.database().ref().child(".info/connected");a.authObj.$onAuthStateChanged(function(c){var d=a.authObj.$getAuth();if(d){var f=firebase.database().ref().child("users/"+c.uid),g=firebase.database().ref().child("loggedIn/"+c.uid),h=firebase.database().ref().child(".info/connected");g.onDisconnect().remove();var k=e(f);k.$bindTo(a,"data"),a.firebaseUser=c,a.userData=e(f);var m=firebase.database().ref().child("loggedIn"),n=e(m);n.$bindTo(a,"loggedIns"),console.log(n),h.on("value",function(b){b.val()===!0?(k.$loaded().then(function(){console.log(a.userData.name),g.child("name").set(k.name),g.child("uid").set(k.uid),g.child("score").set(O)}),console.log("connected"),i()):(console.log("not connected"),console.log("Signed in as:",c.uid))}),a.signOut=function(){var b=e(g);console.log(b),b.$remove().then(function(b){oa.close(),Q=[],T=[],U=[],R=[],S=[],a.authData=null,a.firebaseUser=null,a.authObj.$signOut(),h.off()})},j(),l(),ma()}else a.firebaseUser=null,b.path("/login"),console.log("Signed out")}),a.data=[];var n=firebase.database().ref().child("users"),o=n.orderByChild("score").limitToLast(10);a.users=f(o),a.setScore=function(b){if(cancelAnimationFrame(I),a.firebaseUser){var c=firebase.database().ref().child("users/"+a.firebaseUser.uid);console.log("Final score:"+a.data.score),(b>a.data.score||"undefined"==typeof a.data.score)&&c.child("score").set(b)}},a.updateScore=function(b){if(a.firebaseUser){var c=firebase.database().ref().child("loggedIn/"+a.firebaseUser.uid);c.child("score").set(b)}};var p={points:{gem:5,supergem:10,movingSupergem:50},amount:{gems:30,supergem:10,movingSupergem:3}},q=new WebAudiox.GameSounds;q.lineOut.volume=.4;var r="/sounds/coin.wav",s=q.createClip().register("coin").load(r,function(a){});r="/sounds/durr.wav";var t=q.createClip().register("durr").load(r,function(a){});r="/sounds/bounce.wav";var u=q.createClip().register("bounce").load(r,function(a){});r="/sounds/super.wav";var v=q.createClip().register("super").load(r,function(a){});r="/sounds/success.wav";q.createClip().register("success").load(r,function(a){});Math.radians=function(a){return a*Math.PI/180};var w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L=window.innerWidth/2,M=window.innerHeight/2,N=(new THREE.Clock,document.getElementById("visualisation")),O=0,P=5,Q=[],R=[],S=[],T=[],U=[],V=[],W=!0,X=performance.now(),Y=50,Z=50,_=50,aa=document.getElementById("playButton"),ba=document.getElementById("score"),ca=document.getElementById("finalScore"),da=document.getElementById("life"),ea=document.getElementById("instructions"),fa=!1,ga=!1,ha=!1,ia=!1,ja=!1,ka=!1,la=new THREE.Vector3;a.supergemsCollected=0,a.movingSupergemsCollected=0,a.gemsCollected=0;var ma=function(){SC.get("/users/127459/tracks").then(function(b){var c=$.map(b,function(a){return a}),d=Math.floor(Math.random()*c.length);g.get(c[d].id).success(function(b){var c="a7c99e975fa37c393cb1a6d89d5c1e0b";a.band=b.user.username,a.bandUrl=b.user.permalink_url,a.title=b.title,a.trackUrl=b.permalink_url,a.albumArt=b.artwork_url,a.wave=b.waveform_url,a.stream=b.stream_url+"?client_id="+c,na()})})},na=function(){var b=new Audio(a.stream);b.crossOrigin="anonymous";var c=oa.createMediaElementSource(b);c.connect(pa),pa.connect(oa.destination),pa.fftSize=64,console.log(a.stream),b.volume=.8,b.play(),a.playing=!0,a.play=function(){a.playing=!a.playing,a.playing?(b.play(),a.playing=!0,$("#songPlay").html("stop")):(b.pause(),a.playing=!1,$("#songPlay").html("play"))}},oa=new(window.AudioContext||window.webkitAudioContext),pa=oa.createAnalyser(),qa=new Uint8Array(pa.frequencyBinCount)}]),app.factory("soundcloud",["$http",function(a){var b="a7c99e975fa37c393cb1a6d89d5c1e0b",c="//api.soundcloud.com/tracks/";return{get:function(d){var e=c+d+".json",f={params:{client_id:b,callback:"JSON_CALLBACK"}};return a.jsonp(e,f)}}}]);